#
#
#
# *** If you edit this file, make sure that CONTRIBUTING.md stays up to date.
#
#
#
on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-zip:
    # Even though jou.exe runs on windows, it is compiled on linux.
    # This is by far the easiest way to compile for Windows that I know of.
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      - name: "Cache generated .a files"
        uses: actions/cache@v3
        with:
          path: libs/*.a
          key: ${{ runner.os }}-${{ hashFiles('windows_setup.sh') }}
      - run: source activate && ./windows_setup.sh
        shell: bash
      - run: source activate && mingw32-make
        shell: bash
      - run: mkdir jou
      - name: Copy files
        # Please keep this list of files in sync with update.ps1
        run: cp -rv stdlib doc examples mingw64 LICENSE jou.exe update.ps1 jou
      - name: Copy DLL files
        shell: bash
        run: |
          ready=no
          while [ $ready == no ]; do
            ready=yes
            for file in $(objdump -p jou/jou.exe jou/*.dll | grep 'DLL Name:' | cut -d: -f2 | grep -vEi 'kernel32.dll|msvcrt.dll|advapi32.dll|ole32.dll|shell32.dll'); do
              if ! [ -f jou/$file ]; then
                cp -v mingw64/bin/$file jou/
                ready=no
              fi
            done
          done
      - name: Convert text files to Windows-style CRLF line endings
        run: mingw64/bin/unix2dos $(find jou -name '*.jou') $(find jou -name '*.md') jou/LICENSE
        shell: bash
      - run: zip -r jou.zip jou
        shell: bash
      - uses: actions/upload-artifact@v3
        with:
          name: windows-zip
          path: jou.zip

  test:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
        with:
          # Add a space in the folder name to trigger bugs like #165
          path: "test dir"
      - name: "Cache generated .a files"
        uses: actions/cache@v3
        with:
          path: "test dir/libs/*.a"
          key: ${{ runner.os }}-${{ hashFiles('windows_setup.sh') }}
      - run: cd "test dir" && ./windows_setup.sh
        shell: bash
      - run: cd "test dir" && source activate && ./runtests.sh --verbose
        shell: bash

  compare-compilers:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      - name: "Cache generated .a files"
        uses: actions/cache@v3
        with:
          path: libs/*.a
          key: ${{ runner.os }}-${{ hashFiles('windows_setup.sh') }}
      - run: source activate && ./windows_setup.sh
      - run: source activate && ./compare_compilers.sh
        shell: bash

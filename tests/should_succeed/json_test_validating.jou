import "stdlib/assert.jou"
import "stdlib/io.jou"
import "stdlib/json.jou"
import "stdlib/str.jou"


def test_numbers() -> None:
    assert is_valid_json("3.14")
    assert is_valid_json("-2.5")
    assert is_valid_json("0")
    assert is_valid_json("-0")
    assert is_valid_json("123123123123123123123123123123")  # not practical, but allowed
    assert is_valid_json("1e5")
    assert is_valid_json("-1E+5")
    assert is_valid_json("-1.23E+4")
    assert is_valid_json("-1.23E-4")
    assert is_valid_json("-1.23e+4")
    assert is_valid_json("-1.23e-4")
    assert is_valid_json("  123 \t\r\n ")

    # Technically Infinity and NaN are not valid JSON, but many libraries
    # support them to some extent so we support them too.
    assert is_valid_json("Infinity")
    assert is_valid_json("-Infinity")
    assert is_valid_json("NaN")

    assert not is_valid_json("+2.5")
    assert not is_valid_json("+0")
    assert not is_valid_json("+5")
    assert not is_valid_json("+1.23E+4")
    assert not is_valid_json("+1.23E-4")
    assert not is_valid_json("+1.23e+4")
    assert not is_valid_json("+1.23e-4")
    assert not is_valid_json("00")
    assert not is_valid_json("01")
    assert not is_valid_json("1.23J4")
    assert not is_valid_json("1e2.3")
    assert not is_valid_json("1.2.3")
    assert not is_valid_json("1ee2")
    assert not is_valid_json("--1")
    assert not is_valid_json("5k")

    assert not is_valid_json("infinity")
    assert not is_valid_json("Infinityyyy")
    assert not is_valid_json("Inf")
    assert not is_valid_json("-infinity")
    assert not is_valid_json("-Infinityyyy")
    assert not is_valid_json("-Inf")
    assert not is_valid_json("nan")
    assert not is_valid_json("Na")
    assert not is_valid_json("NaNa")


def test_json_from_github_api() -> None:
    file_content: byte[10000]

    f = fopen("tests/data/jou_github_release.json", "rb")
    assert f != NULL
    n = fread(file_content, 1, sizeof(file_content), f)
    fclose(f)

    assert n < sizeof(file_content)
    file_content[n] = '\0'

    assert is_valid_json(file_content)
    *strrchr(file_content, '}') = ' '
    assert not is_valid_json(file_content)


def main() -> int:
    test_numbers()
    test_json_from_github_api()

    puts("ok")  # Output: ok
    return 0

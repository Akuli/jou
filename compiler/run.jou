import "stdlib/str.jou"
import "stdlib/mem.jou"
import "stdlib/io.jou"
import "stdlib/process.jou"


def run_exe(exepath: byte*, valgrind: bool) -> int:
    command = malloc(strlen(exepath) + 1000)
    if WINDOWS:
        sprintf(command, "\"%s\"", exepath)
        while strstr(command, "/") != NULL:
            *strstr(command, "/") = '\\'
    else:
        if valgrind:
            sprintf(command, "valgrind -q --leak-check=full --show-leak-kinds=all --error-exitcode=1 '%s'", exepath)
        else:
            sprintf(command, "'%s'", exepath)

    # Make sure that everything else shows up before the user's prints.
    fflush(stdout)
    fflush(stderr)

    ret = system(command)
    free(command)

    if ret == 0:
        return 0  # success
    else:
        return 1  # TODO: extract actual error code / return value
